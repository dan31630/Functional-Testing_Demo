name: Run UFT One Tests Action

on:
  workflow_dispatch:

env:
  LAUNCHER_EXE: FTToolsLauncher.exe
  LAUNCHER_URL: https://github.com/MicroFocus/ADM-FT-ToolsLauncher/releases/download/v1.0-beta-rev12/FTToolsLauncher_net48.exe

  # 子系統 → 指定要跑哪些腳本
  # Demo = C:\UFT_Tests\Script\Demo
  # Demo_Login = C:\UFT_Tests\Script\Demo_Login
  SUBSYSTEM_SCRIPT_MAP: '{"SubsystemA":["Demo"],"SubsystemB":["Demo_Login"]}'

defaults:
  run:
    shell: pwsh
    working-directory: .\

jobs:
  runUftTests:
    runs-on: self-hosted

    steps:
      # 1. Checkout repo
      - name: Display the working directory
        run: echo "$pwd"

      - name: Checkout current repo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref_name }}
          clean: false

      # 2. Download FTToolsLauncher if missing
      - name: GET FTToolsLauncher.exe
        run: |
          if (Test-Path $env:LAUNCHER_EXE) {
            Write-Host "FTToolsLauncher.exe already exists"
          }
          else {
            Write-Host "Downloading FTToolsLauncher.exe from $env:LAUNCHER_URL ..."
            Invoke-WebRequest -Uri $env:LAUNCHER_URL -OutFile $env:LAUNCHER_EXE
          }

      # 3. Run tests based on subsystem → script mapping
      - name: Run UFT tests based on subsystem mapping
        run: |
          # ===== parse JSON mapping =====
          $mapJson = $env:SUBSYSTEM_SCRIPT_MAP
          $map = ConvertFrom-Json $mapJson

          # ===== this run's timestamp =====
          $runId = Get-Date -Format 'yyyyMMddHHmmss'

          # ===== define script path lookup table =====
          $scriptPaths = @{
            "Demo"       = "C:\UFT_Tests\Script\Demo"
            "Demo_Login" = "C:\UFT_Tests\Script\Demo_Login"
          }

          $overallFailed = $false

          foreach ($subsystem in $map.PSObject.Properties.Name) {
            Write-Host "============================================="
            Write-Host "   Running scripts for subsystem: $subsystem"
            Write-Host "============================================="

            $scripts = $map.$subsystem

            foreach ($scriptName in $scripts) {
              if (-not $scriptPaths.ContainsKey($scriptName)) {
                Write-Error "Unknown script name: $scriptName"
                exit 1
              }

              $testPath = $scriptPaths[$scriptName]

              # extract actual folder name (Demo / Demo_Login)
              $testFolder = Split-Path -Leaf $testPath

              # report folder
              $resultDir = "C:\UFT_Tests\Reports\$subsystem\$runId\$testFolder"
              New-Item -ItemType Directory -Path $resultDir -Force | Out-Null

              Write-Host "Result directory: $resultDir"

              # properties file name
              $safeSubsystem = $subsystem -replace '[\\/:*?"<>|]', '_'
              $propsFile = "Props_${safeSubsystem}_$testFolder.txt"

              # generate properties file（改掉 here-string，用陣列組字串）
              $propsLines = @(
                "runType=FileSystem"
                "Test1=$testPath"
                "resultsFilename=$resultDir\Results.xml"
                "fsReportPath=$resultDir"
              )
              $propsLines | Out-File -FilePath $propsFile -Encoding utf8

              Write-Host "Created properties file: $propsFile"

              # run FTToolsLauncher
              $p = Start-Process -FilePath "$env:LAUNCHER_EXE" `
                                 -ArgumentList "-paramfile $propsFile" `
                                 -Wait -PassThru -NoNewWindow

              $code = $p.ExitCode
              Write-Host "FTToolsLauncher exit code for $subsystem / $testFolder: $code"

              if ($code -ne 0) {
                Write-Error "FTToolsLauncher failed for $subsystem / $testFolder with exit code $code"
                exit $code
              }

              # validate result
              $resultsPath = Join-Path $resultDir "Results.xml"
              if (!(Test-Path $resultsPath)) {
                Write-Error "Results file missing: $resultsPath"
                exit 1
              }

              [xml]$results = Get-Content $resultsPath
              $xmlText = $results.OuterXml

              if ($xmlText -match 'Failed') {
                Write-Error "UFT test FAILED for $subsystem / $testFolder"
                $overallFailed = $true
              }
              else {
                Write-Host "UFT test PASSED for $subsystem / $testFolder"
              }
            }
          }

          if ($overallFailed) {
            Write-Error "One or more tests FAILED."
            exit 1
          }

          Write-Host "All assigned UFT tests PASSED."
